<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>US WEI</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background: skyblue;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); }
    form {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      z-index: 2;
      margin-bottom: 15px;
    }
    input { padding: 8px; margin: 10px; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 10px 20px; border: none; border-radius: 5px; background: dodgerblue; color: white; font-size: 16px; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
    .ballon {
      position: absolute;
      width: 40px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, white, red);
      border-radius: 50% 50% 50% 50%;
      animation: float 10s infinite ease-in-out;
      opacity: 0.8;
    }
    @keyframes float { from { transform: translateY(100vh) scale(1);} to { transform: translateY(-120vh) scale(1.2);} }
    #resetForm { display: none; }
    #adminLink { cursor: pointer; color: white; font-size: 12px; position: fixed; bottom: 5px; right: 10px; }
    #message, #resetMessage { min-height: 1.2em; }
  </style>
</head>
<body>
  <h1>US WEI</h1>

  <form id="partyForm">
    <label for="code">Entrez votre code rÃ¨glement :</label><br>
    <input type="password" id="code" required>
    <br>
    <button type="submit" id="submitBtn">Valider</button>
    <p id="message" aria-live="polite"></p>
    <p>Places restantes : <span id="remaining">Chargementâ€¦</span></p>
  </form>

  <form id="resetForm">
    <label for="resetCode">Code admin (reset) :</label><br>
    <input type="password" id="resetCode">
    <br>
    <button type="submit">Reset Compteur</button>
    <p id="resetMessage" aria-live="polite"></p>
  </form>

  <p id="adminLink">Admin</p>

  <script>
    // âš¡ Config Firebase (remplace par TES vraies valeurs depuis console.firebase.google.com)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-ID-default-rtdb.europe-west1.firebasedatabase.app", // forme actuelle de l'URL
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // SÃ©curitÃ© : empÃªche l'app de planter silencieusement si la config n'est pas remplie
    let firebaseOk = true;
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      firebaseOk = false;
      console.error(e);
      document.getElementById('message').textContent = "Erreur de configuration Firebase. VÃ©rifie la config.";
    }

    const db = firebaseOk ? firebase.database() : null;

    // === ParamÃ¨tres ===
    const MAX_PLACES = 2; // mets 100 ou la valeur rÃ©elle
    const REDIRECT_URL = "https://www.helloasso.com/associations/tribu-ensae/evenements/wer-ensae-2025";

    // Codes en base64
    const codeUserEncoded = "MTQ4NjUy"; // 148652
    const codeAdminEncoded = "MTUzNA=="; // 1534

    function decode(str) { return atob(str); }

    const remainingSpan = document.getElementById("remaining");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById("submitBtn");

    if (firebaseOk) {
      const counterRef = db.ref("placesUsed");

      // Initialise le compteur Ã  0 s'il n'existe pas
      counterRef.once('value').then(snap => {
        if (snap.val() === null) counterRef.set(0);
      }).catch(err => {
        console.error(err);
        messageEl.textContent = "Impossible de lire le compteur.";
      });

      // ðŸ”„ Ã‰coute en temps rÃ©el du compteur
      counterRef.on("value", (snapshot) => {
        let used = snapshot.val() ?? 0;
        const remaining = Math.max(0, MAX_PLACES - used);
        remainingSpan.textContent = remaining;
      }, (err) => {
        console.error(err);
        remainingSpan.textContent = "?";
        messageEl.textContent = "Erreur de connexion Ã  la base.";
      });

      // Validation utilisateur (transaction atomique pour Ã©viter les doubles rÃ©servations)
      document.getElementById("partyForm").addEventListener("submit", function(e) {
        e.preventDefault();
        messageEl.textContent = "";
        const code = document.getElementById("code").value.trim();

        if (code !== decode(codeUserEncoded)) {
          messageEl.textContent = "Code incorrect. RÃ©essayez.";
          return;
        }

        submitBtn.disabled = true;
        counterRef.transaction(current => {
          if (current === null) return 1; // premiÃ¨re validation
          if (current < MAX_PLACES) return current + 1; // on incrÃ©mente si quota non atteint
          return; // abort si quota atteint
        }, (error, committed, snapshot) => {
          submitBtn.disabled = false;
          if (error) {
            console.error(error);
            messageEl.textContent = "Erreur rÃ©seau. RÃ©essayez.";
          } else if (!committed) {
            messageEl.textContent = "DÃ©solÃ©, le quota est atteint.";
          } else {
            window.location.href = REDIRECT_URL;
          }
        });
      });

      // Admin reset (via code admin)
      document.getElementById("resetForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const resetCode = document.getElementById("resetCode").value.trim();
        const resetMessage = document.getElementById("resetMessage");

        if (resetCode === decode(codeAdminEncoded)) {
          counterRef.set(0).then(() => {
            resetMessage.textContent = "Compteur rÃ©initialisÃ© avec succÃ¨s !";
          }).catch(err => {
            console.error(err);
            resetMessage.textContent = "Erreur lors du reset.";
          });
        } else {
          resetMessage.textContent = "Code admin incorrect.";
        }
      });
    }

    document.getElementById("adminLink").addEventListener("click", function() {
      document.getElementById("resetForm").style.display = "block";
    });

    // ðŸŽˆ Ballons animÃ©s
    for (let i = 0; i < 20; i++) {
      let ballon = document.createElement("div");
      ballon.className = "ballon";
      ballon.style.left = Math.random() * 100 + "vw";
      ballon.style.background = `radial-gradient(circle at 30% 30%, white, hsl(${Math.random()*360}, 80%, 60%))`;
      ballon.style.animationDuration = (8 + Math.random()*5) + "s";
      document.body.appendChild(ballon);
    }
  </script>
</body>
</html>
