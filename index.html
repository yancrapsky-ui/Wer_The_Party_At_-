<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Wer The Party ?</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background: skyblue;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); }
    form {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      z-index: 2;
      margin-bottom: 15px;
    }
    input { padding: 8px; margin: 10px; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 10px 20px; border: none; border-radius: 5px; background: dodgerblue; color: white; font-size: 16px; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
    .ballon {
      position: absolute;
      width: 40px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, white, red);
      border-radius: 50% 50% 50% 50%;
      animation: float 10s infinite ease-in-out;
      opacity: 0.8;
    }
    @keyframes float { from { transform: translateY(100vh) scale(1);} to { transform: translateY(-120vh) scale(1.2);} }
    #resetForm { display: none; }
    #adminLink { cursor: pointer; color: white; font-size: 12px; position: fixed; bottom: 5px; right: 10px; }
  </style>
</head>
<body>
  <h1>Wer The Party At ?!</h1>

  <form id="partyForm">
    <label for="code">Entrez votre code VSS :</label><br>
    <input type="password" id="code" required>
    <br>
    <button type="submit">Valider</button>
    <p id="message"></p>
    <p>Places restantes : <span id="remaining"></span></p>
  </form>

  <form id="resetForm">
    <label for="resetCode">Code admin (reset) :</label><br>
    <input type="password" id="resetCode">
    <br>
    <button type="submit">Reset Compteur</button>
    <p id="resetMessage"></p>
  </form>

  <p id="adminLink">Admin</p>

  <script>
    // ‚ö° Config Firebase (√† remplacer par tes propres infos depuis console.firebase.google.com)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MAX_PLACES = 100;
    const REDIRECT_URL = "https://www.helloasso.com/associations/tribu-ensae/evenements/wer-ensae-2025";

    // Codes en base64
    const codeUserEncoded = "ODY0Nw==";
    const codeAdminEncoded = "MTUzNA==";

    function decode(str) { return atob(str); }

    const remainingSpan = document.getElementById("remaining");

    // üîÑ √âcoute en temps r√©el du compteur
    const counterRef = db.ref("placesUsed");
    counterRef.on("value", (snapshot) => {
      let used = snapshot.val() ?? 0;
      remainingSpan.textContent = MAX_PLACES - used;
    });

    // Validation utilisateur
    document.getElementById("partyForm").addEventListener("submit", function(e) {
      e.preventDefault();
      let code = document.getElementById("code").value;
      let message = document.getElementById("message");

      counterRef.once("value").then((snap) => {
        let used = snap.val() ?? 0;
        if (used >= MAX_PLACES) {
          message.textContent = "D√©sol√©, le quota est atteint.";
          return;
        }
        if (code === decode(codeUserEncoded)) {
          counterRef.set(used + 1);
          window.location.href = REDIRECT_URL;
        } else {
          message.textContent = "Code incorrect. R√©essayez.";
        }
      });
    });

    // Admin reset
    document.getElementById("resetForm").addEventListener("submit", function(e) {
      e.preventDefault();
      let resetCode = document.getElementById("resetCode").value;
      let resetMessage = document.getElementById("resetMessage");

      if (resetCode === decode(codeAdminEncoded)) {
        counterRef.set(0);
        resetMessage.textContent = "Compteur r√©initialis√© avec succ√®s !";
      } else {
        resetMessage.textContent = "Code admin incorrect.";
      }
    });

    document.getElementById("adminLink").addEventListener("click", function() {
      document.getElementById("resetForm").style.display = "block";
    });

    // üéà Ballons anim√©s
    for (let i = 0; i < 20; i++) {
      let ballon = document.createElement("div");
      ballon.className = "ballon";
      ballon.style.left = Math.random() * 100 + "vw";
      ballon.style.background = `radial-gradient(circle at 30% 30%, white, hsl(${Math.random()*360}, 80%, 60%))`;
      ballon.style.animationDuration = (8 + Math.random()*5) + "s";
      document.body.appendChild(ballon);
    }
  </script>
</body>
</html>
